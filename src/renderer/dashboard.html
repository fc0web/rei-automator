<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rei Automator Dashboard — Phase 9e</title>
<script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body,#root{height:100%}
body{background:#0c0e12;color:#c0c5d0;font-family:'Noto Sans JP','SF Pro Display',-apple-system,sans-serif}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:#2a2d38;border-radius:3px}
@keyframes pulse-glow{0%,100%{opacity:.6}50%{opacity:1}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideIn{from{opacity:0;transform:translateX(-10px)}to{opacity:1;transform:translateX(0)}}
textarea:focus,input:focus{outline:none;border-color:#8ba4b8!important}
.tab-btn{background:none;border:none;color:#4a5060;cursor:pointer;display:flex;align-items:center;gap:6px;padding:8px 14px;border-radius:6px;font-size:13px;font-weight:500;transition:all .2s;font-family:'Noto Sans JP',sans-serif}
.tab-btn:hover{color:#8a90a0;background:rgba(139,164,184,.06)}
.tab-btn.active{color:#c0c8d4;background:rgba(139,164,184,.1)}
.ab{background:rgba(139,164,184,.08);border:1px solid #22252e;color:#8a90a0;cursor:pointer;padding:6px 12px;border-radius:6px;font-size:12px;display:inline-flex;align-items:center;gap:5px;transition:all .2s;font-family:'Noto Sans JP',sans-serif}
.ab:hover{background:rgba(139,164,184,.14);color:#c0c8d4;border-color:#30333e}
.ab.p{background:rgba(139,164,184,.15);border-color:#8ba4b830;color:#a0b8cc}
.ab.p:hover{background:rgba(139,164,184,.22)}
.ab.d{color:#f87171}
.ab.d:hover{background:rgba(248,113,113,.1);border-color:rgba(248,113,113,.2)}
.mo{position:fixed;inset:0;background:rgba(0,0,0,.65);display:flex;align-items:center;justify-content:center;z-index:100;backdrop-filter:blur(4px);animation:fadeIn .2s}
.mc{background:#13151a;border:1px solid #22252e;border-radius:14px;padding:24px;min-width:420px;max-width:520px;animation:fadeIn .25s}
.ll{display:flex;gap:10px;padding:3px 0;font-size:12.5px;line-height:1.5;font-family:'JetBrains Mono',monospace;animation:slideIn .2s}
.tr{display:grid;grid-template-columns:32px 1fr 80px 120px 80px 60px;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;transition:background .2s;cursor:pointer;border-bottom:1px solid #16181e}
.tr:hover{background:rgba(139,164,184,.04)}
.kr{display:grid;grid-template-columns:1fr 180px 80px 120px 120px 40px;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid #16181e}
.nr{display:grid;grid-template-columns:32px 1fr 90px 100px 80px 100px;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;transition:background .2s;border-bottom:1px solid #16181e}
.nr:hover{background:rgba(139,164,184,.04)}
.sc{background:linear-gradient(135deg,#13151a,#181b22);border:1px solid #22252e;border-radius:10px;padding:16px 18px;display:flex;align-items:center;gap:14;transition:border-color .3s,box-shadow .3s;cursor:default}
.sc:hover{border-color:rgba(139,164,184,.25);box-shadow:0 0 20px rgba(139,164,184,.06)}
.sc.mi{padding:12px 14px;gap:10px}
.pn{background:linear-gradient(180deg,#13151a,#111318);border:1px solid #1e2028;border-radius:12px;padding:18px}
.conn-dot{width:7px;height:7px;border-radius:50%}
.conn-dot.live{background:#6ee7b7;animation:pulse-glow 2s infinite}
.conn-dot.ws{background:#6ee7b7;animation:pulse-glow 2s infinite}
.conn-dot.poll{background:#fbbf24;animation:pulse-glow 3s infinite}
.conn-dot.off{background:#f87171}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const{useState,useEffect,useRef,useCallback}=React;

/* ─── Configuration ─── */
const CFG={
  API: location.origin !== "null" ? location.origin : "http://localhost:19720",
  WS: (location.origin !== "null" ? location.origin : "http://localhost:19720").replace(/^http/,"ws"),
  POLL: 5000,
};

/* ── Icons ── */
const Z={
Activity:p=><svg width={p.s||16} height={p.s||16} viewBox="0 0 24 24" fill="none" stroke={p.c||"currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>,
Cpu:p=><svg width={p.s||16} height={p.s||16} viewBox="0 0 24 24" fill="none" stroke={p.c||"currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="4" y="4" width="16" height="16" rx="2"/><rect x="9" y="9" width="6" height="6"/><line x1="9" y1="1" x2="9" y2="4"/><line x1="15" y1="1" x2="15" y2="4"/><line x1="9" y1="20" x2="9" y2="23"/><line x1="15" y1="20" x2="15" y2="23"/><line x1="20" y1="9" x2="23" y2="9"/><line x1="20" y1="14" x2="23" y2="14"/><line x1="1" y1="9" x2="4" y2="9"/><line x1="1" y1="14" x2="4" y2="14"/></svg>,
Clock:p=><svg width={p.s||16} height={p.s||16} viewBox="0 0 24 24" fill="none" stroke={p.c||"currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
Key:p=><svg width={p.s||16} height={p.s||16} viewBox="0 0 24 24" fill="none" stroke={p.c||"currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>,
Play:p=><svg width={p.s||16} height={p.s||16} viewBox="0 0 24 24" fill="none" stroke={p.c||"currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
Sq:p=><svg width={p.s||16} height={p.s||16} viewBox="0 0 24 24" fill="none" stroke={p.c||"currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>,
Ref:p=><svg width={p.s||16} height={p.s||16} viewBox="0 0 24 24" fill="none" stroke={p.c||"currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
WOff:p=><svg width={p.s||16} height={p.s||16} viewBox="0 0 24 24" fill="none" stroke={p.c||"currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="1" y1="1" x2="23" y2="23"/><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/><line x1="12" y1="20" x2="12.01" y2="20"/></svg>,
CDown:p=><svg width={p.s||16} height={p.s||16} viewBox="0 0 24 24" fill="none" stroke={p.c||"currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"/></svg>,
CRight:p=><svg width={p.s||16} height={p.s||16} viewBox="0 0 24 24" fill="none" stroke={p.c||"currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"/></svg>,
Trash:p=><svg width={p.s||16} height={p.s||16} viewBox="0 0 24 24" fill="none" stroke={p.c||"currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
Plus:p=><svg width={p.s||16} height={p.s||16} viewBox="0 0 24 24" fill="none" stroke={p.c||"currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
Eye:p=><svg width={p.s||16} height={p.s||16} viewBox="0 0 24 24" fill="none" stroke={p.c||"currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
Alert:p=><svg width={p.s||16} height={p.s||16} viewBox="0 0 24 24" fill="none" stroke={p.c||"currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
Check:p=><svg width={p.s||16} height={p.s||16} viewBox="0 0 24 24" fill="none" stroke={p.c||"currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
Load:p=><svg width={p.s||16} height={p.s||16} viewBox="0 0 24 24" fill="none" stroke={p.c||"currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={p.spin?{animation:"spin 1s linear infinite"}:{}}><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></svg>,
Srv:p=><svg width={p.s||16} height={p.s||16} viewBox="0 0 24 24" fill="none" stroke={p.c||"currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="2" width="20" height="8" rx="2"/><rect x="2" y="14" width="20" height="8" rx="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/></svg>,
Zap:p=><svg width={p.s||16} height={p.s||16} viewBox="0 0 24 24" fill="none" stroke={p.c||"currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
Bar3:p=><svg width={p.s||16} height={p.s||16} viewBox="0 0 24 24" fill="none" stroke={p.c||"currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>,
Scroll:p=><svg width={p.s||16} height={p.s||16} viewBox="0 0 24 24" fill="none" stroke={p.c||"currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M8 21h12a2 2 0 0 0 2-2v-2H10v2a2 2 0 1 1-4 0V5a2 2 0 1 0-4 0v3h4"/><path d="M19 17V5a2 2 0 0 0-2-2H4"/></svg>,
Gear:p=><svg width={p.s||16} height={p.s||16} viewBox="0 0 24 24" fill="none" stroke={p.c||"currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c.26.6.85 1 1.51 1H21a2 2 0 0 1 0 4h-.09c-.66.01-1.25.4-1.51 1z"/></svg>,
Send:p=><svg width={p.s||16} height={p.s||16} viewBox="0 0 24 24" fill="none" stroke={p.c||"currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
X:p=><svg width={p.s||16} height={p.s||16} viewBox="0 0 24 24" fill="none" stroke={p.c||"currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
Net:p=><svg width={p.s||16} height={p.s||16} viewBox="0 0 24 24" fill="none" stroke={p.c||"currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="2" width="6" height="6" rx="1"/><rect x="2" y="16" width="6" height="6" rx="1"/><rect x="16" y="16" width="6" height="6" rx="1"/><path d="M12 8v4"/><path d="M5 16v-2a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v2"/></svg>,
Share:p=><svg width={p.s||16} height={p.s||16} viewBox="0 0 24 24" fill="none" stroke={p.c||"currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>,
Globe:p=><svg width={p.s||16} height={p.s||16} viewBox="0 0 24 24" fill="none" stroke={p.c||"currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>,
};

/* ── SVG Charts ── */
function BarSVG({data,w=500,h=170,k1="executions",k2="errors",c1="#6ee7b7",c2="#f87171",lk="hour",li=3}){
  if(!data||!data.length)return null;
  const mx=Math.max(...data.map(d=>Math.max(d[k1]||0,d[k2]||0)),1);
  const bw=Math.max(2,(w-40)/data.length/2-2);const ch=h-30;
  return <svg width="100%" height={h} viewBox={`0 0 ${w} ${h}`} style={{display:"block"}}>
    {[.25,.5,.75,1].map(f=><line key={f} x1="35" y1={ch*(1-f)+5} x2={w} y2={ch*(1-f)+5} stroke="#1a1d24" strokeDasharray="3 3"/>)}
    {[0,.5,1].map(f=><text key={f} x="30" y={ch*(1-f)+9} fill="#3a4050" fontSize="10" textAnchor="end">{Math.round(mx*f)}</text>)}
    {data.map((d,i)=>{const x=40+i*((w-40)/data.length);const h1=(d[k1]||0)/mx*ch;const h2=(d[k2]||0)/mx*ch;
      return <g key={i}><rect x={x} y={ch-h1+5} width={bw} height={h1} fill={c1+"40"} stroke={c1} strokeWidth=".8" rx="2"/><rect x={x+bw+1} y={ch-h2+5} width={bw} height={Math.max(h2,0)} fill={c2+"40"} stroke={c2} strokeWidth=".8" rx="2"/>{i%li===0&&<text x={x+bw} y={h-4} fill="#3a4050" fontSize="10" textAnchor="middle">{d[lk]}</text>}</g>;})}
  </svg>;
}
function AreaSVG({data,w=500,h=170,keys=[{k:"mem",c:"#a78bfa",l:"Memory"},{k:"cpu",c:"#60a5fa",l:"CPU"}],mx=100}){
  if(!data||!data.length)return null;const ch=h-25,cw=w-40;
  const pts=(k)=>data.map((d,i)=>`${40+(i/(data.length-1))*cw},${5+ch*(1-(d[k]||0)/mx)}`).join(" ");
  const area=(k)=>{const p=data.map((d,i)=>`${40+(i/(data.length-1))*cw},${5+ch*(1-(d[k]||0)/mx)}`);return `${p.join(" ")} ${40+cw},${ch+5} 40,${ch+5}`;};
  return <svg width="100%" height={h} viewBox={`0 0 ${w} ${h}`} style={{display:"block"}}>
    {[.25,.5,.75,1].map(f=><line key={f} x1="35" y1={ch*(1-f)+5} x2={w} y2={ch*(1-f)+5} stroke="#1a1d24" strokeDasharray="3 3"/>)}
    {[0,.5,1].map(f=><text key={f} x="30" y={ch*(1-f)+9} fill="#3a4050" fontSize="10" textAnchor="end">{Math.round(mx*f)}</text>)}
    {keys.map(k=><g key={k.k}><polygon points={area(k.k)} fill={k.c+"12"}/><polyline points={pts(k.k)} fill="none" stroke={k.c} strokeWidth="1.5" strokeLinejoin="round"/></g>)}
    {keys.map((k,i)=><g key={k.k+"l"}><line x1={w-140+i*75} y1={h-6} x2={w-128+i*75} y2={h-6} stroke={k.c} strokeWidth="2"/><text x={w-124+i*75} y={h-2} fill="#4a5060" fontSize="10">{k.l}</text></g>)}
  </svg>;
}
function Donut({data,sz=130}){
  const tot=data.reduce((s,d)=>s+d.value,0)||1;const cx=sz/2,cy=sz/2,r=sz*.38,r2=sz*.25;let ca=-Math.PI/2;
  const arcs=data.map(d=>{const a=(d.value/tot)*Math.PI*2;const sa=ca;ca+=a;const ea=ca;const g=.03;
    const x1=cx+r*Math.cos(sa+g),y1=cy+r*Math.sin(sa+g),x2=cx+r*Math.cos(ea-g),y2=cy+r*Math.sin(ea-g);
    const x3=cx+r2*Math.cos(ea-g),y3=cy+r2*Math.sin(ea-g),x4=cx+r2*Math.cos(sa+g),y4=cy+r2*Math.sin(sa+g);
    return{...d,path:`M${x1},${y1} A${r},${r} 0 ${a>Math.PI?1:0} 1 ${x2},${y2} L${x3},${y3} A${r2},${r2} 0 ${a>Math.PI?1:0} 0 ${x4},${y4} Z`};});
  return <svg width={sz} height={sz} viewBox={`0 0 ${sz} ${sz}`}>{arcs.map((a,i)=><path key={i} d={a.path} fill={a.color+"80"}/>)}<text x={cx} y={cy+4} textAnchor="middle" fill="#6a7080" fontSize="11" fontFamily="'JetBrains Mono',monospace">{tot}</text></svg>;
}

/* ── API Client ── */
const api = {
  _key: null,
  _headers() {
    const h = { "Content-Type": "application/json" };
    if (this._key) h["Authorization"] = "Bearer " + this._key;
    return h;
  },
  async get(path) {
    const res = await fetch(CFG.API + path, { headers: this._headers() });
    if (!res.ok) throw new Error(res.status + " " + res.statusText);
    return res.json();
  },
  async post(path, body) {
    const res = await fetch(CFG.API + path, {
      method: "POST", headers: this._headers(), body: JSON.stringify(body),
    });
    if (!res.ok) throw new Error(res.status + " " + res.statusText);
    return res.json();
  },
  async del(path) {
    const res = await fetch(CFG.API + path, {
      method: "DELETE", headers: this._headers(),
    });
    if (!res.ok) throw new Error(res.status + " " + res.statusText);
    return res.json();
  },
  setKey(k) { this._key = k || null; },
};

/* ── Utils ── */
const F={
  up:s=>{if(!s&&s!==0)return"\u2014";const d=Math.floor(s/86400),h=Math.floor(s%86400/3600),m=Math.floor(s%3600/60);return d>0?d+"d "+h+"h "+m+"m":h>0?h+"h "+m+"m":m+"m";},
  t:ts=>ts?new Date(ts).toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit",second:"2-digit"}):"\u2014",
  ago:ts=>{if(!ts)return"\u2014";const s=Math.floor((Date.now()-ts)/1000);if(s<60)return s+"\u79D2\u524D";if(s<3600)return Math.floor(s/60)+"\u5206\u524D";return Math.floor(s/3600)+"\u6642\u9593\u524D";},
};
const SC={completed:{c:"#6ee7b7",i:"Check",l:"\u5B8C\u4E86"},running:{c:"#93c5fd",i:"Load",l:"\u5B9F\u884C\u4E2D"},queued:{c:"#a5a5a5",i:"Clock",l:"\u5F85\u6A5F"},error:{c:"#fca5a5",i:"Alert",l:"\u30A8\u30E9\u30FC"}};
const LC={info:"#8ba4b8",warn:"#fbbf24",error:"#f87171",debug:"#6b7280"};
const PC={admin:"#f0abfc",execute:"#93c5fd",read:"#a5b4c4"};

/* ── Widgets ── */
const Stat=({ic,lb,vl,sub,ac="#8ba4b8",mi})=>{const Icon=Z[ic];return<div className={"sc"+(mi?" mi":"")}><div style={{width:mi?32:38,height:mi?32:38,borderRadius:8,background:ac+"12",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}><Icon s={mi?15:17} c={ac}/></div><div style={{minWidth:0}}><div style={{fontSize:11,color:"#5a6070",textTransform:"uppercase",letterSpacing:".06em",marginBottom:2}}>{lb}</div><div style={{fontSize:mi?18:22,fontWeight:700,color:"#d0d5de",fontFamily:"'JetBrains Mono',monospace",lineHeight:1.1}}>{vl}</div>{sub&&<div style={{fontSize:11,color:"#4a5060",marginTop:2}}>{sub}</div>}</div></div>;};
const SH=({ic,tl,ac="#8ba4b8",act})=>{const Icon=Z[ic];return<div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:14}}><div style={{display:"flex",alignItems:"center",gap:8}}><Icon s={16} c={ac}/><span style={{fontSize:14,fontWeight:600,color:"#c0c5d0",letterSpacing:".02em"}}>{tl}</span></div>{act}</div>;};
const Bdg=({t,c})=><span style={{fontSize:10,fontWeight:600,color:c,background:c+"18",padding:"2px 8px",borderRadius:4,textTransform:"uppercase",letterSpacing:".05em"}}>{t}</span>;

/* ── App ── */
function App(){
  const[connMode,setConnMode]=useState("connecting");
  const wsRef=useRef(null);
  const reconnRef=useRef(null);

  const[st,setSt]=useState({up:0,tr:0,tq:0,tru:0,err:0,mem:0,ws:0,pid:0,cluster:null});
  const[tasks,setTasks]=useState([]);
  const[logs,setLogs]=useState([]);
  const[hist,setHist]=useState([]);
  const[keys,setKeys]=useState([]);
  const[nodes,setNodes]=useState([]);
  const[mh,setMh]=useState([]);

  const[tab,setTab]=useState("overview");
  const[code,setCode]=useState("");
  const[sR,setSR]=useState(false);
  const[sK,setSK]=useState(false);
  const[sD,setSD]=useState(false);
  const[kn,setKn]=useState("");
  const[kp,setKp]=useState("read");
  const[lf,setLf]=useState("all");
  const[et,setEt]=useState(null);
  const[dt,setDt]=useState("");
  const[dc,setDc]=useState("");
  const[apiKey,setApiKey]=useState(function(){try{return localStorage.getItem("rei-api-key")||"";}catch(e){return"";}});
  const le=useRef(null);

  useEffect(function(){
    api.setKey(apiKey);
    try{if(apiKey)localStorage.setItem("rei-api-key",apiKey);else localStorage.removeItem("rei-api-key");}catch(e){}
  },[apiKey]);

  /* ── Fetch helpers ── */
  const fetchStats=useCallback(async function(){
    try{
      const d=await api.get("/health");
      const mem=Math.round((d.memoryMB||0)*10)/10;
      setSt({up:d.uptime||0,tr:d.completedTasks||0,tq:d.queueLength||0,tru:d.activeTasks||0,err:d.errorTasks||0,mem:mem,ws:d.wsClients||0,pid:d.pid||0,cluster:d.cluster||null});
      setMh(function(p){var next=p.concat([{t:p.length?p[p.length-1].t+1:0,mem:mem,cpu:0}]);return next.slice(-60);});
      return true;
    }catch(e){return false;}
  },[]);

  const fetchTasks=useCallback(async function(){
    try{
      const d=await api.get("/api/tasks");
      setTasks((d.tasks||[]).map(function(t){return{id:t.id,name:t.name,status:t.running?"running":(t.lastResult==="error"?"error":(t.lastResult==="success"?"completed":"queued")),sa:t.lastRun?new Date(t.lastRun).getTime():null,ca:t.lastResult?new Date(t.lastRun).getTime():null,sch:t.schedule||null,ret:t.errorCount||0,err:t.lastError||null};}));
    }catch(e){}
  },[]);

  const fetchLogs=useCallback(async function(){
    try{
      const d=await api.get("/api/logs?limit=200");
      setLogs((d.logs||[]).map(function(l){return{ts:new Date(l.timestamp).getTime(),lv:l.level,msg:l.message};}));
    }catch(e){}
  },[]);

  const fetchKeys=useCallback(async function(){
    try{
      const d=await api.get("/api/keys");
      setKeys((d.keys||[]).map(function(k){return{key:k.key||k.prefix||"\u2014",name:k.name,perm:(k.permissions||[]).join(","),cat:k.createdAt?new Date(k.createdAt).toISOString().slice(0,10):"\u2014",lu:k.lastUsed?new Date(k.lastUsed).toISOString().slice(0,10):null};}));
    }catch(e){}
  },[]);

  const fetchNodes=useCallback(async function(){
    try{
      const d=await api.get("/api/cluster/nodes");
      setNodes((d.nodes||[]).map(function(n){return{id:n.id,name:n.name,host:n.host,st:n.status||"online",tasks:n.stats&&n.stats.activeTasks||0,cpu:n.stats&&n.stats.cpuPercent||0,role:n.role||"worker",ls:n.lastHeartbeat||Date.now()};}));
    }catch(e){}
  },[]);

  const buildHist=useCallback(function(logData){
    var hours={};
    for(var i=0;i<24;i++){var h=String(i).padStart(2,"0")+":00";hours[h]={hour:h,executions:0,errors:0};}
    for(var j=0;j<logData.length;j++){var l=logData[j];var hr=new Date(l.ts).getHours();var hk=String(hr).padStart(2,"0")+":00";if(hours[hk]){if(l.lv==="error")hours[hk].errors++;else hours[hk].executions++;}}
    setHist(Object.values(hours));
  },[]);

  /* ── WebSocket ── */
  const connectWs=useCallback(function(){
    if(wsRef.current&&wsRef.current.readyState<2)return;
    try{
      var ws=new WebSocket(CFG.WS+"/ws");
      ws.onopen=function(){
        setConnMode("ws");
        ws.send(JSON.stringify({type:"identify",name:"dashboard-9e"}));
        ws.send(JSON.stringify({type:"subscribe",channels:["all"]}));
      };
      ws.onmessage=function(ev){
        try{
          var msg=JSON.parse(ev.data);
          if(msg.type==="log"&&msg.data){
            setLogs(function(p){return p.slice(-499).concat([{ts:Date.now(),lv:msg.data.level,msg:msg.data.message}]);});
          }else if(msg.type==="task"&&msg.data){
            fetchTasks();
          }else if(msg.type==="stats"&&msg.data){
            var d=msg.data;var mem=Math.round((d.memoryMB||0)*10)/10;
            setSt(function(prev){return Object.assign({},prev,{up:d.uptime||prev.up,tr:d.completedTasks||prev.tr,tq:d.queueLength||0,tru:d.activeTasks||0,err:d.errorTasks||prev.err,mem:mem,ws:d.wsClients||0,cluster:d.cluster||prev.cluster});});
            setMh(function(p){return p.concat([{t:p.length?p[p.length-1].t+1:0,mem:mem,cpu:0}]).slice(-60);});
          }
        }catch(e){}
      };
      ws.onclose=function(){
        setConnMode(function(p){return p==="ws"?"poll":p;});
        wsRef.current=null;
        reconnRef.current=setTimeout(connectWs,5000);
      };
      ws.onerror=function(){ws.close();};
      wsRef.current=ws;
    }catch(e){setConnMode("poll");}
  },[fetchTasks]);

  /* ── Init + Polling ── */
  useEffect(function(){
    var active=true;
    var init=async function(){
      var ok=await fetchStats();
      if(!active)return;
      if(ok){setConnMode("poll");connectWs();await Promise.all([fetchTasks(),fetchLogs(),fetchNodes()]);}
      else{setConnMode("off");}
    };
    init();
    var pollId=setInterval(async function(){
      if(!active)return;
      var ok=await fetchStats();
      if(ok){setConnMode(function(p){return p==="off"?"poll":p;});await fetchTasks();}
      else{setConnMode("off");}
    },CFG.POLL);
    return function(){active=false;clearInterval(pollId);if(reconnRef.current)clearTimeout(reconnRef.current);if(wsRef.current)wsRef.current.close();};
  },[]);

  useEffect(function(){if(tab==="logs")fetchLogs();if(tab==="keys")fetchKeys();if(tab==="nodes")fetchNodes();},[tab]);
  useEffect(function(){if(tab==="logs"&&le.current)le.current.scrollIntoView({behavior:"smooth"});},[logs,tab]);
  useEffect(function(){if(logs.length>0)buildHist(logs);},[logs.length]);

  /* ── Actions ── */
  var run=async function(){
    if(!code.trim())return;
    try{var res=await api.post("/api/tasks/run",{code:code,name:"dashboard-exec"});setLogs(function(p){return p.concat([{ts:Date.now(),lv:"info",msg:"Queued: "+(res.taskId||"remote")}]);});setCode("");setSR(false);setTimeout(fetchTasks,500);}
    catch(e){setLogs(function(p){return p.concat([{ts:Date.now(),lv:"error",msg:"Run failed: "+e.message}]);});}
  };
  var stop=async function(id){
    try{await api.post("/api/tasks/"+id+"/stop",{});setTimeout(fetchTasks,300);}
    catch(e){setLogs(function(p){return p.concat([{ts:Date.now(),lv:"error",msg:"Stop failed: "+e.message}]);});}
  };
  var addKey=async function(){
    if(!kn.trim())return;
    try{await api.post("/api/keys",{name:kn,permissions:[kp]});setKn("");setSK(false);fetchKeys();}
    catch(e){setLogs(function(p){return p.concat([{ts:Date.now(),lv:"error",msg:"Key create: "+e.message}]);});}
  };
  var delKey=async function(k){
    try{await api.del("/api/keys/"+k);fetchKeys();}
    catch(e){setLogs(function(p){return p.concat([{ts:Date.now(),lv:"error",msg:"Key delete: "+e.message}]);});}
  };
  var reload=async function(){
    try{await api.post("/api/daemon/reload",{});setLogs(function(p){return p.concat([{ts:Date.now(),lv:"info",msg:"Daemon reload requested"}]);});}
    catch(e){setLogs(function(p){return p.concat([{ts:Date.now(),lv:"error",msg:"Reload: "+e.message}]);});}
  };
  var dispatch=async function(){
    if(!dt||!dc.trim())return;
    try{await api.post("/api/dispatch",{code:dc,targetNodeId:dt});setLogs(function(p){return p.concat([{ts:Date.now(),lv:"info",msg:"[9d] Dispatched to "+dt}]);});setDc("");setSD(false);setTimeout(fetchTasks,500);}
    catch(e){setLogs(function(p){return p.concat([{ts:Date.now(),lv:"error",msg:"Dispatch: "+e.message}]);});}
  };

  /* ── Computed ── */
  var fl=lf==="all"?logs:logs.filter(function(l){return l.lv===lf;});
  var ts={completed:tasks.filter(function(t){return t.status==="completed";}).length,running:tasks.filter(function(t){return t.status==="running";}).length,queued:tasks.filter(function(t){return t.status==="queued";}).length,error:tasks.filter(function(t){return t.status==="error";}).length};
  var pd=Object.entries(ts).filter(function(e){return e[1]>0;}).map(function(e){return{name:SC[e[0]].l,value:e[1],color:SC[e[0]].c};});
  var on=nodes.filter(function(n){return n.st==="online";});
  var tnt=on.reduce(function(s,n){return s+n.tasks;},0);
  var ac=on.length?Math.round(on.reduce(function(s,n){return s+n.cpu;},0)/on.length*10)/10:0;
  var connLabel={ws:{c:"#6ee7b7",l:"WebSocket",dot:"ws"},poll:{c:"#fbbf24",l:"\u30DD\u30FC\u30EA\u30F3\u30B0",dot:"poll"},off:{c:"#f87171",l:"\u672A\u63A5\u7D9A",dot:"off"},connecting:{c:"#93c5fd",l:"\u63A5\u7D9A\u4E2D...",dot:"poll"}}[connMode];
  var tabs=[{id:"overview",l:"\u6982\u8981",i:"Bar3"},{id:"tasks",l:"\u30BF\u30B9\u30AF",i:"Cpu"},{id:"nodes",l:"\u30CE\u30FC\u30C9",i:"Net"},{id:"logs",l:"\u30ED\u30B0",i:"Scroll"},{id:"keys",l:"API\u30AD\u30FC",i:"Key"},{id:"settings",l:"\u8A2D\u5B9A",i:"Gear"}];

  return <div style={{minHeight:"100vh",background:"#0c0e12",color:"#c0c5d0",fontFamily:"'Noto Sans JP',sans-serif"}}>
    <header style={{borderBottom:"1px solid #1a1d24",padding:"12px 24px",display:"flex",alignItems:"center",justifyContent:"space-between",position:"sticky",top:0,zIndex:50,backdropFilter:"blur(12px)",background:"rgba(12,14,18,.85)"}}>
      <div style={{display:"flex",alignItems:"center",gap:14}}>
        <div style={{width:32,height:32,borderRadius:8,background:"linear-gradient(135deg,#2a3040,#1a1d28)",border:"1px solid #2a2d38",display:"flex",alignItems:"center",justifyContent:"center",fontSize:16,fontWeight:700,color:"#8ba4b8",fontFamily:"'JetBrains Mono',monospace"}}>{"\u96F6"}</div>
        <div><div style={{fontSize:15,fontWeight:600,color:"#d0d5de"}}>Rei Automator <span style={{fontSize:11,color:"#4a5060",fontWeight:400}}>v0.6.0</span></div><div style={{fontSize:10.5,color:"#3a4050",letterSpacing:".04em"}}>DASHBOARD — PHASE 9e LIVE</div></div>
      </div>
      <div style={{display:"flex",alignItems:"center",gap:14}}>
        <div style={{display:"flex",alignItems:"center",gap:6,fontSize:12}}>
          <div className={"conn-dot "+(connLabel?connLabel.dot:"off")}/><span style={{color:connLabel?connLabel.c:"#f87171"}}>{connLabel?connLabel.l:"\u672A\u63A5\u7D9A"}</span>
          {connMode!=="off"&&connMode!=="connecting"&&<React.Fragment><span style={{color:"#3a4050",fontSize:11,margin:"0 3px"}}>|</span><span style={{color:"#4a5060",fontFamily:"'JetBrains Mono',monospace",fontSize:11}}>PID {st.pid}</span>{nodes.length>0&&<React.Fragment><span style={{color:"#3a4050",fontSize:11,margin:"0 3px"}}>|</span><Z.Net s={12} c="#60a5fa"/><span style={{color:"#60a5fa"}}>{on.length}/{nodes.length}</span></React.Fragment>}</React.Fragment>}
        </div>
        <button className="ab p" onClick={function(){setSR(true);}}><Z.Play s={12}/> {"\u5B9F\u884C"}</button>
        {nodes.length>0&&<button className="ab" onClick={function(){setSD(true);}}><Z.Share s={12}/> {"\u5206\u914D"}</button>}
        <button className="ab" onClick={reload}><Z.Ref s={12}/></button>
      </div>
    </header>

    <nav style={{borderBottom:"1px solid #16181e",padding:"0 24px",display:"flex",gap:2}}>
      {tabs.map(function(t){var Ic=Z[t.i];return<button key={t.id} className={"tab-btn "+(tab===t.id?"active":"")} onClick={function(){setTab(t.id);}}><Ic s={14}/>{t.l}</button>;})}
    </nav>

    <main style={{padding:"20px 24px",maxWidth:1280,margin:"0 auto"}}>

      {tab==="overview"&&<div style={{display:"flex",flexDirection:"column",gap:18,animation:"fadeIn .3s"}}>
        <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(170px,1fr))",gap:12}}>
          <Stat ic="Clock" lb={"\u7A3C\u50CD\u6642\u9593"} vl={F.up(st.up)} ac="#8ba4b8"/>
          <Stat ic="Zap" lb={"\u5B8C\u4E86\u30BF\u30B9\u30AF"} vl={st.tr} sub={st.tru+" \u5B9F\u884C\u4E2D / "+st.tq+" \u5F85\u6A5F"} ac="#6ee7b7"/>
          <Stat ic="Alert" lb={"\u30A8\u30E9\u30FC"} vl={st.err} ac="#f87171"/>
          <Stat ic="Cpu" lb={"\u30E1\u30E2\u30EA"} vl={st.mem+"MB"} sub={"WS "+st.ws+"\u63A5\u7D9A"} ac="#a78bfa"/>
          {nodes.length>0&&<Stat ic="Net" lb={"\u30CE\u30FC\u30C9"} vl={on.length+"/"+nodes.length} sub={"avg "+ac+"%"} ac="#60a5fa"/>}
          {tnt>0&&<Stat ic="Share" lb={"\u5206\u6563\u30BF\u30B9\u30AF"} vl={tnt} ac="#fbbf24"/>}
        </div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:14}}>
          <div className="pn"><SH ic="Bar3" tl={"\u5B9F\u884C\u5C65\u6B74\uFF0824\u6642\u9593\uFF09"} ac="#6ee7b7"/>{hist.length>0?<BarSVG data={hist}/>:<div style={{color:"#2a2d38",fontSize:12,textAlign:"center",padding:40}}>{"\u30ED\u30B0\u30C7\u30FC\u30BF\u306A\u3057"}</div>}</div>
          <div className="pn"><SH ic="Activity" tl={"\u30E1\u30E2\u30EA\u4F7F\u7528\u91CF"} ac="#a78bfa"/>{mh.length>1?<AreaSVG data={mh} keys={[{k:"mem",c:"#a78bfa",l:"Memory (MB)"}]} mx={Math.max(100,Math.max.apply(null,mh.map(function(d){return d.mem||0;}))*1.2)||100}/>:<div style={{color:"#2a2d38",fontSize:12,textAlign:"center",padding:40}}>{"\u53CE\u96C6\u4E2D..."}</div>}</div>
        </div>
        <div style={{display:"grid",gridTemplateColumns:"260px 1fr",gap:14}}>
          <div className="pn"><SH ic="Cpu" tl={"\u30BF\u30B9\u30AF\u72B6\u6CC1"} ac="#93c5fd"/><div style={{display:"flex",justifyContent:"center",marginBottom:10}}><Donut data={pd.length>0?pd:[{name:"\u306A\u3057",value:1,color:"#2a2d38"}]}/></div>
            <div style={{display:"flex",flexDirection:"column",gap:6}}>{Object.entries(SC).map(function(e){return<div key={e[0]} style={{display:"flex",alignItems:"center",justifyContent:"space-between",fontSize:12}}><div style={{display:"flex",alignItems:"center",gap:6}}><div style={{width:8,height:8,borderRadius:2,background:e[1].c+"80"}}/><span style={{color:"#6a7080"}}>{e[1].l}</span></div><span style={{color:e[1].c,fontFamily:"'JetBrains Mono',monospace",fontWeight:600}}>{ts[e[0]]}</span></div>;})}</div>
          </div>
          <div className="pn"><SH ic="Scroll" tl={"\u6700\u65B0\u30ED\u30B0"} ac="#8ba4b8" act={<button className="ab" onClick={function(){setTab("logs");}} style={{fontSize:11}}>{"\u5168\u3066 \u2192"}</button>}/>
            <div style={{maxHeight:200,overflowY:"auto",fontFamily:"'JetBrains Mono',monospace"}}>{logs.length>0?logs.slice(-10).map(function(l,i){return<div key={i} className="ll" style={{opacity:.5+(i/10)*.5}}><span style={{color:"#22252e",flexShrink:0}}>{F.t(l.ts)}</span><span style={{color:LC[l.lv]||"#6b7280",flexShrink:0,width:40,textAlign:"right"}}>{l.lv}</span><span style={{color:"#8a90a0"}}>{l.msg}</span></div>;}):<div style={{color:"#2a2d38",fontSize:12,textAlign:"center",padding:20}}>{"\u30ED\u30B0\u306A\u3057"}</div>}</div>
          </div>
        </div>
      </div>}

      {tab==="tasks"&&<div style={{animation:"fadeIn .3s"}}><div className="pn">
        <SH ic="Cpu" tl={"\u30BF\u30B9\u30AF\u4E00\u89A7"} ac="#93c5fd" act={<div style={{display:"flex",gap:8}}><button className="ab p" onClick={function(){setSR(true);}}><Z.Play s={12}/> {"\u65B0\u898F"}</button>{nodes.length>0&&<button className="ab" onClick={function(){setSD(true);}}><Z.Share s={12}/> {"\u5206\u914D"}</button>}</div>}/>
        <div style={{display:"grid",gridTemplateColumns:"32px 1fr 80px 120px 80px 60px",gap:10,padding:"6px 12px",fontSize:11,color:"#3a4050",borderBottom:"1px solid #1a1d24",textTransform:"uppercase",letterSpacing:".06em"}}><span/><span>{"\u30BF\u30B9\u30AF"}</span><span>{"\u72B6\u614B"}</span><span>{"\u6642\u523B"}</span><span>{"\u4E88\u7D04"}</span><span/></div>
        {tasks.length>0?tasks.map(function(t){var c=SC[t.status]||SC.queued;var Ic=Z[c.i];return<div key={t.id}>
          <div className="tr" onClick={function(){setEt(et===t.id?null:t.id);}}>
            <div style={{display:"flex",alignItems:"center",justifyContent:"center"}}><Ic s={15} c={c.c}/></div>
            <div><div style={{fontSize:13,color:"#c0c8d4",fontWeight:500}}>{t.name}</div><div style={{fontSize:11,color:"#3a4050",fontFamily:"'JetBrains Mono',monospace"}}>{t.id}</div></div>
            <Bdg t={c.l} c={c.c}/>
            <div style={{fontSize:12,color:"#5a6070",fontFamily:"'JetBrains Mono',monospace"}}>{F.t(t.sa)}</div>
            <div style={{fontSize:11,color:t.sch?"#fbbf24":"#2a2d38"}}>{t.sch||"\u2014"}</div>
            <div style={{display:"flex",gap:4}}>{t.status==="running"&&<button className="ab d" style={{padding:"4px 6px"}} onClick={function(e){e.stopPropagation();stop(t.id);}}><Z.Sq s={11}/></button>}{et===t.id?<Z.CDown s={14} c="#4a5060"/>:<Z.CRight s={14} c="#2a2d38"/>}</div>
          </div>
          {et===t.id&&<div style={{padding:"10px 12px 10px 54px",fontSize:12,color:"#5a6070",background:"rgba(139,164,184,.02)",borderBottom:"1px solid #16181e",animation:"fadeIn .2s"}}>
            <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:8}}><div>{"\u958B\u59CB: "}{F.t(t.sa)}</div><div>{"\u5B8C\u4E86: "}{F.t(t.ca)}</div><div>{"\u30EA\u30C8\u30E9\u30A4: "}{t.ret}{"\u56DE"}</div></div>
            {t.err&&<div style={{marginTop:6,color:"#f87171",fontFamily:"'JetBrains Mono',monospace",fontSize:11}}>{"\u26A0 "}{t.err}</div>}
          </div>}
        </div>;}):<div style={{color:"#3a4050",fontSize:13,textAlign:"center",padding:40}}>{"\u30BF\u30B9\u30AF\u306A\u3057 \u2014 \u300C\u65B0\u898F\u300D\u30DC\u30BF\u30F3\u3067\u30BF\u30B9\u30AF\u3092\u5B9F\u884C\u3067\u304D\u307E\u3059"}</div>}
      </div></div>}

      {tab==="nodes"&&<div style={{animation:"fadeIn .3s",display:"flex",flexDirection:"column",gap:16}}>
        {nodes.length===0?<div className="pn" style={{textAlign:"center",padding:40,color:"#3a4050"}}><Z.Net s={24} c="#2a2d38"/><div style={{marginTop:12,fontSize:13}}>{"\u30AF\u30E9\u30B9\u30BF\u304C\u7121\u52B9\u304B\u3001\u30CE\u30FC\u30C9\u60C5\u5831\u304C\u3042\u308A\u307E\u305B\u3093"}</div><div style={{fontSize:11,color:"#2a2d38",marginTop:4}}>{"clusterEnabled: true \u3067\u6709\u52B9\u5316"}</div></div>:<React.Fragment>
        <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(170px,1fr))",gap:12}}>
          <Stat ic="Srv" lb={"\u7DCF\u30CE\u30FC\u30C9"} vl={nodes.length} sub={on.length+" \u30AA\u30F3\u30E9\u30A4\u30F3"} ac="#60a5fa"/>
          <Stat ic="Zap" lb={"\u5206\u6563\u30BF\u30B9\u30AF"} vl={tnt} ac="#6ee7b7"/>
          <Stat ic="Cpu" lb={"\u5E73\u5747CPU"} vl={ac+"%"} ac="#a78bfa"/>
          <Stat ic="Globe" lb={"\u30EA\u30FC\u30C0\u30FC"} vl={(function(){var n=nodes.find(function(n){return n.role==="leader";});return n?n.name.split(" ")[0]:"\u2014";})()  } ac="#fbbf24"/>
        </div>
        <div className="pn"><SH ic="Net" tl={"\u30C8\u30DD\u30ED\u30B8\u30FC"} ac="#60a5fa"/>
          <div style={{display:"flex",justifyContent:"center",gap:24,padding:"20px 0",flexWrap:"wrap"}}>
            {nodes.map(function(n){var isL=n.role==="leader",isO=n.st==="online",nac=isL?"#fbbf24":isO?"#6ee7b7":"#f87171";
              return<div key={n.id} style={{display:"flex",flexDirection:"column",alignItems:"center",gap:8}}>
                <div style={{position:"relative"}}><div style={{width:72,height:72,borderRadius:14,background:"linear-gradient(135deg,"+nac+"08,"+nac+"04)",border:"1.5px solid "+nac+(isO?"40":"15"),display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center"}}><Z.Srv s={20} c={nac}/><div style={{fontSize:9,color:nac,marginTop:4,fontWeight:600}}>{isL?"LEADER":"WORKER"}</div></div><div style={{position:"absolute",top:-3,right:-3,width:10,height:10,borderRadius:"50%",background:isO?"#6ee7b7":"#f87171",border:"2px solid #0c0e12",animation:isO?"pulse-glow 2s infinite":"none"}}/></div>
                <div style={{textAlign:"center"}}><div style={{fontSize:12,color:"#c0c8d4",fontWeight:500}}>{n.name.split("(")[0].trim()}</div><div style={{fontSize:10,color:"#4a5060",fontFamily:"'JetBrains Mono',monospace"}}>{n.host}</div>{isO&&<div style={{fontSize:10,color:"#3a4050",marginTop:2}}>{"CPU "+n.cpu+"% \u00B7 "+n.tasks+"\u30BF\u30B9\u30AF"}</div>}</div>
              </div>;})}
          </div>
          <div style={{textAlign:"center",fontSize:11,color:"#2a2d38",marginTop:4}}>{"\u2500\u2500 REST API :19720 \u76F8\u4E92\u901A\u4FE1 \u2500\u2500"}</div>
        </div>
        <div className="pn"><SH ic="Srv" tl={"\u30CE\u30FC\u30C9\u4E00\u89A7"} ac="#60a5fa" act={<button className="ab" onClick={function(){setSD(true);}}><Z.Share s={12}/> {"\u5206\u914D"}</button>}/>
          <div style={{display:"grid",gridTemplateColumns:"32px 1fr 90px 100px 80px 100px",gap:10,padding:"6px 12px",fontSize:11,color:"#3a4050",borderBottom:"1px solid #1a1d24",textTransform:"uppercase"}}><span/><span>{"\u540D\u524D"}</span><span>{"\u72B6\u614B"}</span><span>{"\u30BF\u30B9\u30AF"}</span><span>CPU</span><span>{"\u5FDC\u7B54"}</span></div>
          {nodes.map(function(n){var nc=n.st==="online"?{c:"#6ee7b7",l:"\u7A3C\u50CD\u4E2D"}:{c:"#f87171",l:"\u505C\u6B62"};return<div key={n.id} className="nr"><div style={{display:"flex",alignItems:"center",justifyContent:"center"}}><Z.Srv s={15} c={nc.c}/></div><div><div style={{fontSize:13,color:"#c0c8d4",fontWeight:500}}>{n.name} {n.role==="leader"&&<Bdg t="Leader" c="#fbbf24"/>}</div><div style={{fontSize:11,color:"#3a4050",fontFamily:"'JetBrains Mono',monospace"}}>{n.host}</div></div><Bdg t={nc.l} c={nc.c}/><div style={{fontSize:13,color:"#c0c8d4",fontFamily:"'JetBrains Mono',monospace"}}>{n.tasks}</div><div style={{fontSize:12,color:n.cpu>70?"#f87171":n.cpu>40?"#fbbf24":"#6ee7b7",fontFamily:"'JetBrains Mono',monospace"}}>{n.st==="online"?n.cpu+"%":"\u2014"}</div><div style={{fontSize:11,color:"#4a5060"}}>{F.ago(n.ls)}</div></div>;})}
        </div>
        <div className="pn"><SH ic="Share" tl={"\u5206\u914D\u6226\u7565"} ac="#fbbf24"/>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:14}}>
            {[{n:"Round Robin",d:"\u9806\u756A\u306B\u5747\u7B49\u5206\u914D",a:true},{n:"Least Load",d:"\u8CA0\u8377\u6700\u5C0F\u30CE\u30FC\u30C9\u512A\u5148",a:false},{n:"Affinity",d:"\u30BF\u30B9\u30AF\u2192\u30CE\u30FC\u30C9\u56FA\u5B9A",a:false}].map(function(s){return<div key={s.n} style={{padding:"14px 16px",borderRadius:10,background:s.a?"rgba(251,191,36,.06)":"rgba(139,164,184,.03)",border:"1px solid "+(s.a?"#fbbf2430":"#1e2028"),cursor:"pointer"}}><div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:6}}><span style={{fontSize:13,fontWeight:600,color:s.a?"#fbbf24":"#6a7080"}}>{s.n}</span>{s.a&&<Bdg t={"\u6709\u52B9"} c="#fbbf24"/>}</div><div style={{fontSize:11.5,color:"#4a5060"}}>{s.d}</div></div>;})}
          </div>
        </div>
        </React.Fragment>}
      </div>}

      {tab==="logs"&&<div style={{animation:"fadeIn .3s"}}><div className="pn" style={{height:"calc(100vh - 180px)",display:"flex",flexDirection:"column"}}>
        <SH ic="Scroll" tl={"\u30EA\u30A2\u30EB\u30BF\u30A4\u30E0\u30ED\u30B0"} ac="#8ba4b8" act={<div style={{display:"flex",gap:4}}>{["all","info","warn","error","debug"].map(function(v){return<button key={v} className={"ab "+(lf===v?"p":"")} onClick={function(){setLf(v);}} style={{fontSize:11,padding:"4px 8px"}}>{v==="all"?"\u5168\u3066":v}</button>;})}</div>}/>
        <div style={{flex:1,overflowY:"auto",fontFamily:"'JetBrains Mono',monospace",background:"#0a0c10",borderRadius:8,padding:"10px 14px",border:"1px solid #16181e"}}>
          {fl.length>0?fl.map(function(l,i){return<div key={i} className="ll"><span style={{color:"#22252e",flexShrink:0,fontSize:11}}>{F.t(l.ts)}</span><span style={{color:LC[l.lv]||"#6b7280",flexShrink:0,width:44,textAlign:"right",fontSize:11,fontWeight:600}}>{l.lv}</span><span style={{color:"#8a90a0",fontSize:12}}>{l.msg}</span></div>;}):<div style={{color:"#2a2d38",fontSize:12,textAlign:"center",padding:40}}>{"\u30ED\u30B0\u306A\u3057"}</div>}
          <div ref={le}/>
        </div>
      </div></div>}

      {tab==="keys"&&<div style={{animation:"fadeIn .3s"}}><div className="pn">
        <SH ic="Key" tl={"API\u30AD\u30FC\u7BA1\u7406"} ac="#f0abfc" act={<button className="ab p" onClick={function(){setSK(true);}}><Z.Plus s={12}/> {"\u65B0\u898F"}</button>}/>
        <div className="kr" style={{fontSize:11,color:"#3a4050",textTransform:"uppercase",borderBottom:"1px solid #1a1d24"}}><span>{"\u540D\u524D"}</span><span>{"\u30AD\u30FC"}</span><span>{"\u6A29\u9650"}</span><span>{"\u4F5C\u6210\u65E5"}</span><span>{"\u6700\u7D42"}</span><span/></div>
        {keys.length>0?keys.map(function(k){return<div key={k.key} className="kr"><div style={{fontSize:13,color:"#c0c8d4",fontWeight:500}}>{k.name}</div><div style={{fontSize:12,color:"#4a5060",fontFamily:"'JetBrains Mono',monospace"}}>{k.key}</div><Bdg t={k.perm} c={PC[k.perm&&k.perm.split(",")[0]]||"#a5b4c4"}/><div style={{fontSize:12,color:"#4a5060"}}>{k.cat}</div><div style={{fontSize:12,color:"#4a5060"}}>{k.lu||"\u2014"}</div><button className="ab d" style={{padding:"4px 6px"}} onClick={function(){delKey(k.key);}}><Z.Trash s={12}/></button></div>;}):<div style={{color:"#3a4050",fontSize:12,textAlign:"center",padding:30}}>{"admin\u6A29\u9650\u306EAPI\u30AD\u30FC\u3067\u8A8D\u8A3C\u3059\u308B\u3068\u8868\u793A\u3055\u308C\u307E\u3059"}</div>}
      </div></div>}

      {tab==="settings"&&<div style={{animation:"fadeIn .3s",display:"flex",flexDirection:"column",gap:14}}>
        <div className="pn"><SH ic="Key" tl={"API\u8A8D\u8A3C"} ac="#f0abfc"/>
          <div style={{marginBottom:14}}>
            <div style={{fontSize:11,color:"#4a5060",marginBottom:6}}>{"API\u30AD\u30FC\uFF08Bearer\u8A8D\u8A3C\uFF09"}</div>
            <div style={{display:"flex",gap:8}}>
              <input value={apiKey} onChange={function(e){setApiKey(e.target.value);}} placeholder="rei_xxxxxx..." type="password" style={{flex:1,background:"#0a0c10",border:"1px solid #1e2028",borderRadius:6,padding:"8px 12px",color:"#c0c8d4",fontSize:13,fontFamily:"'JetBrains Mono',monospace"}}/>
              <button className="ab" onClick={function(){setApiKey("");}} style={{fontSize:11}}>{"\u30AF\u30EA\u30A2"}</button>
            </div>
            <div style={{fontSize:10.5,color:"#2a2d38",marginTop:6}}>{"\u8A2D\u5B9A\u3059\u308B\u3068read/execute/admin API\u306B\u8A8D\u8A3C\u4ED8\u304D\u3067\u30A2\u30AF\u30BB\u30B9\u3057\u307E\u3059\u3002\u30D6\u30E9\u30A6\u30B6\u306B\u4FDD\u5B58\u3055\u308C\u307E\u3059\u3002"}</div>
          </div>
        </div>
        <div className="pn"><SH ic="Srv" tl={"\u63A5\u7D9A\u8A2D\u5B9A"} ac="#60a5fa"/>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:14}}>
            <div><div style={{fontSize:11,color:"#4a5060",marginBottom:6}}>API</div><div style={{fontSize:13,color:"#8a90a0",fontFamily:"'JetBrains Mono',monospace",background:"#0a0c10",padding:"8px 12px",borderRadius:6,border:"1px solid #1a1d24"}}>{CFG.API}</div></div>
            <div><div style={{fontSize:11,color:"#4a5060",marginBottom:6}}>WebSocket</div><div style={{fontSize:13,color:"#8a90a0",fontFamily:"'JetBrains Mono',monospace",background:"#0a0c10",padding:"8px 12px",borderRadius:6,border:"1px solid #1a1d24"}}>{CFG.WS+"/ws"}</div></div>
          </div>
          <div style={{marginTop:10,display:"flex",alignItems:"center",gap:8}}><div className={"conn-dot "+(connLabel?connLabel.dot:"off")}/><span style={{fontSize:12,color:connLabel?connLabel.c:"#f87171"}}>{connLabel?connLabel.l:""}</span>{connMode==="ws"&&<Bdg t={"\u30EA\u30A2\u30EB\u30BF\u30A4\u30E0"} c="#6ee7b7"/>}{connMode==="poll"&&<Bdg t={CFG.POLL/1000+"\u79D2\u9593\u9694"} c="#fbbf24"/>}</div>
        </div>
        <div className="pn"><SH ic="Activity" tl={"\u30C7\u30FC\u30E2\u30F3\u60C5\u5831"} ac="#6ee7b7"/>
          <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:12}}><Stat mi ic="Clock" lb={"\u7A3C\u50CD\u6642\u9593"} vl={F.up(st.up)} ac="#8ba4b8"/><Stat mi ic="Cpu" lb={"\u30AD\u30E5\u30FC"} vl={st.tq} ac="#93c5fd"/><Stat mi ic="Eye" lb={"\u76E3\u8996\u5BFE\u8C61"} vl={st.wf||0} ac="#60a5fa"/></div>
          <div style={{marginTop:14,display:"flex",gap:8}}><button className="ab" onClick={reload}><Z.Ref s={12}/> {"\u30EA\u30ED\u30FC\u30C9"}</button><button className="ab" onClick={function(){fetchStats();fetchTasks();fetchLogs();fetchNodes();fetchKeys();}}><Z.Ref s={12}/> {"\u5168\u53D6\u5F97"}</button></div>
        </div>
        <div className="pn"><SH ic="Zap" tl="Rei-AIOS" ac="#fbbf24"/>
          <div style={{fontSize:12.5,color:"#5a6070",lineHeight:1.8}}>
            <div style={{marginBottom:4}}>{"\uD83C\uDF0C Layer 0: \u5B87\u5B99\u56F3\u66F8\u9928"}</div><div style={{marginBottom:4}}>{"\u2B50 Layer 1: Rei\uFF08\u516C\u7406\u30FB\u7406\u8AD6\uFF09"}</div>
            <div style={{marginBottom:4}}><span style={{color:"#fbbf24"}}>{"\uD83E\uDD16 Layer 2: Rei-AIOS\uFF08\u5B9F\u88C5\uFF09"}</span> <Bdg t={"\u73FE\u5728\u5730"} c="#fbbf24"/></div>
            <div style={{marginTop:10,padding:"10px 14px",background:"#0a0c10",borderRadius:8,border:"1px solid #1a1d24",fontStyle:"italic",color:"#6a7080"}}>"AI is not an app. AI is a participant."</div>
          </div>
        </div>
      </div>}
    </main>

    {sR&&<div className="mo" onClick={function(){setSR(false);}}><div className="mc" onClick={function(e){e.stopPropagation();}}>
      <div style={{display:"flex",justifyContent:"space-between",marginBottom:16}}><span style={{fontSize:15,fontWeight:600,color:"#d0d5de"}}>{"\u30BF\u30B9\u30AF\u5B9F\u884C"}</span><button className="ab" style={{padding:"4px 6px"}} onClick={function(){setSR(false);}}><Z.X s={14}/></button></div>
      <textarea value={code} onChange={function(e){setCode(e.target.value);}} placeholder={"click 500 300\nwait 1000\ntype \"hello\""} rows={7} style={{width:"100%",background:"#0a0c10",border:"1px solid #1e2028",borderRadius:8,padding:"10px 14px",color:"#c0c8d4",fontSize:13,resize:"vertical",fontFamily:"'JetBrains Mono',monospace",lineHeight:1.6}}/>
      <div style={{display:"flex",justifyContent:"flex-end",gap:8,marginTop:14}}><button className="ab" onClick={function(){setSR(false);}}>{"\u53D6\u6D88"}</button><button className="ab p" onClick={run}><Z.Send s={12}/> {"\u5B9F\u884C"}</button></div>
    </div></div>}

    {sK&&<div className="mo" onClick={function(){setSK(false);}}><div className="mc" onClick={function(e){e.stopPropagation();}}>
      <div style={{display:"flex",justifyContent:"space-between",marginBottom:16}}><span style={{fontSize:15,fontWeight:600,color:"#d0d5de"}}>{"API\u30AD\u30FC\u4F5C\u6210"}</span><button className="ab" style={{padding:"4px 6px"}} onClick={function(){setSK(false);}}><Z.X s={14}/></button></div>
      <div style={{marginBottom:14}}><div style={{fontSize:12,color:"#5a6070",marginBottom:6}}>{"\u540D\u524D"}</div><input value={kn} onChange={function(e){setKn(e.target.value);}} placeholder="CI/CD Runner" style={{width:"100%",background:"#0a0c10",border:"1px solid #1e2028",borderRadius:6,padding:"8px 12px",color:"#c0c8d4",fontSize:13}}/></div>
      <div style={{marginBottom:14}}><div style={{fontSize:12,color:"#5a6070",marginBottom:6}}>{"\u6A29\u9650"}</div><div style={{display:"flex",gap:8}}>{["read","execute","admin"].map(function(p){return<button key={p} className={"ab "+(kp===p?"p":"")} onClick={function(){setKp(p);}} style={{flex:1,justifyContent:"center"}}>{p}</button>;})}</div></div>
      <div style={{display:"flex",justifyContent:"flex-end",gap:8}}><button className="ab" onClick={function(){setSK(false);}}>{"\u53D6\u6D88"}</button><button className="ab p" onClick={addKey}><Z.Key s={12}/> {"\u4F5C\u6210"}</button></div>
    </div></div>}

    {sD&&<div className="mo" onClick={function(){setSD(false);}}><div className="mc" onClick={function(e){e.stopPropagation();}}>
      <div style={{display:"flex",justifyContent:"space-between",marginBottom:16}}><span style={{fontSize:15,fontWeight:600,color:"#d0d5de"}}>{"\u5206\u914D\u5B9F\u884C "}<Bdg t="9d" c="#60a5fa"/></span><button className="ab" style={{padding:"4px 6px"}} onClick={function(){setSD(false);}}><Z.X s={14}/></button></div>
      <div style={{marginBottom:12}}><div style={{fontSize:12,color:"#5a6070",marginBottom:6}}>{"\u30BF\u30FC\u30B2\u30C3\u30C8"}</div><div style={{display:"flex",gap:6,flexWrap:"wrap"}}>{nodes.filter(function(n){return n.st==="online";}).map(function(n){return<button key={n.id} className={"ab "+(dt===n.id?"p":"")} onClick={function(){setDt(n.id);}} style={{fontSize:12}}><Z.Srv s={11}/>{n.name.split("(")[0].trim()}</button>;})}</div></div>
      <div style={{marginBottom:14}}><div style={{fontSize:12,color:"#5a6070",marginBottom:6}}>{"\u30B3\u30FC\u30C9"}</div><textarea value={dc} onChange={function(e){setDc(e.target.value);}} placeholder="click 500 300" rows={4} style={{width:"100%",background:"#0a0c10",border:"1px solid #1e2028",borderRadius:8,padding:"10px 14px",color:"#c0c8d4",fontSize:13,resize:"vertical",fontFamily:"'JetBrains Mono',monospace",lineHeight:1.6}}/></div>
      <div style={{display:"flex",justifyContent:"flex-end",gap:8}}><button className="ab" onClick={function(){setSD(false);}}>{"\u53D6\u6D88"}</button><button className="ab p" onClick={dispatch}><Z.Share s={12}/> {"\u5206\u914D"}</button></div>
    </div></div>}

    <footer style={{borderTop:"1px solid #12141a",padding:"10px 24px",display:"flex",justifyContent:"space-between",fontSize:11,color:"#2a2d38"}}><span>Rei Automator v0.6.0 — Phase 9e Live</span><span>{"\u96F6 \u2014 AI is not an app. AI is a participant."}</span></footer>
  </div>;
}

ReactDOM.render(React.createElement(App), document.getElementById("root"));
</script>
</body>
</html>
